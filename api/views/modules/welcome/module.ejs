<%- include('../modules.ejs') %>

<style>
    .card textarea {
        width: 80px;
        height: 50px;
    }

    .card button {
        background-color: #161f25;
        color: white;
        border-radius: 20px;
    }
</style>

<div class="main-content">
    <header style="margin-bottom: 30px;">
        <h1 style="margin: 0;">よろしくメッセージ</h1><br/>

        <div style="display: flex; align-items: center; gap: 15px;">
            <label class="switch-container" style="position: relative; display: inline-block; width: 46px; height: 24px;">
            <input type="checkbox" 
                class="module-toggle" 
                id="module_setting"
                data-guild-id="<%= guild.id %>" 
                data-module-path="<%= path %>"
                <%= enabled ? 'checked' : '' %>
                style="opacity: 0; width: 0; height: 0;">
            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #72767d; transition: .4s; border-radius: 24px;"></span>
            </label>
            <span class="status-text" style="font-size: 0.85rem; font-weight: bold; min-width: 35px; color: <%= enabled ? 'var(--success)' : 'var(--text-muted)' %>">
                <%= enabled ? '有効' : '無効' %>
            </span>
        </div>
    </header>

    <div class="card">
        <h3>
            参加メッセージの指定
        </h3>

        <p>
            <h4>送信先チャンネル</h4>
            <select id="channel">
                <% channels.forEach(ch => { %>
                    <option value="<%= ch.id %>"><%= ch.name %></option>
                <% }); %>
            </select>
            <h4>埋め込みのタイトル</h4>
            <textarea id="join_message_title"><%= msg_title %></textarea>
            <h4>埋め込みの説明</h4>
            <textarea id="join_message_description"><%= msg_description %></textarea>
            <br/>
            <button onclick="updateJoinMessage()">更新</button>
        </p>
    </div>
</div>
<script>
    async function updateJoinMessage() {
        const guildId = "<%= guild.id %>";
        const title_value = document.getElementById("join_message_title").value;
        const description_value = document.getElementById("join_message_description").value;
        const channel = document.getElementById("channel").value;

        const response = await fetch(`/api/guilds/${guildId}/welcome`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title_value, description: description_value, channel: channel })
        });
    }

    document.getElementById("module_setting").addEventListener('change', async (e) => {
        const isEnabled = e.target.checked;
        const guildId = e.target.dataset.guildId;
        const moduleName = e.target.dataset.modulePath;
        const statusText = e.target.parentElement.nextElementSibling;

        statusText.innerText = isEnabled ? '有効' : '無効';
        statusText.style.color = isEnabled ? 'var(--success)' : 'var(--text-muted)';

        try {
            const response = await fetch(`/api/modules/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guildId, module: moduleName })
            });

            const title_value = document.getElementById("join_message_title").value = "";
            const description_value = document.getElementById("join_message_description").value = "";

            await fetch(`/api/guilds/${guildId}/welcome`, {
                method: "DELETE",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guildId })
            });

            if (!response.ok) throw new Error('保存に失敗しました');
        } catch (err) {
            alert('設定の保存中にエラーが発生しました');
            e.target.checked = !isEnabled;
            statusText.innerText = !isEnabled ? '有効' : '無効';
        }
    });
</script>