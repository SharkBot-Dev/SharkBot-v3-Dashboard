<%- include('modules.ejs') %>

<div class="main-content">
    <header style="margin-bottom: 30px;">
        <h1 style="margin: 0;"><%= title %></h1>
        <p style="color: var(--text-muted); margin-top: 5px;">ã“ã®ã‚µãƒ¼ãƒãƒ¼ã§åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã®ä¸€è¦§ã§ã™ã€‚</p>
    </header>

    <div class="card">
        <h2 style="font-size: 1.2rem; margin-bottom: 20px;">ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§</h2>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <% if (locals.moduleList && moduleList.length > 0) { %>
                <% moduleList.forEach(mod => { %>
                    <% if (mod) { %>
                        <a href="/guilds/<%= guild.id %>/<%= mod.pathname %>" 
                           style="text-decoration: none; color: inherit; transition: transform 0.1s;"
                           onmouseover="this.style.transform='scale(1.01)'" 
                           onmouseout="this.style.transform='scale(1)'">
                           
                            <div class="module-item" style="display: flex; align-items: center; justify-content: space-between; padding: 18px; background: #36393f; border-radius: 8px; border: 1px solid transparent; transition: 0.2s;" 
                                 onmouseover="this.style.borderColor='var(--primary-color)'" 
                                 onmouseout="this.style.borderColor='transparent'">
                                
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <span style="font-size: 1.8rem;"><%= mod.emoji || 'ğŸ“¦' %></span>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1rem;"><%= mod.name %></div>
                                        <% if (mod.description) { %>
                                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 2px;">
                                                <%= mod.description %>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <label class="switch-container" style="position: relative; display: inline-block; width: 46px; height: 24px;">
                                        <input type="checkbox" 
                                            class="module-toggle" 
                                            data-guild-id="<%= guild.id %>" 
                                            data-module-path="<%= mod.pathname %>"
                                            <%= mod.enabled ? 'checked' : '' %>
                                            style="opacity: 0; width: 0; height: 0;">
                                        <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #72767d; transition: .4s; border-radius: 24px;"></span>
                                    </label>
                                    <span class="status-text" style="font-size: 0.85rem; font-weight: bold; min-width: 35px; color: <%= mod.enabled ? 'var(--success)' : 'var(--text-muted)' %>">
                                        <%= mod.enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹' %>
                                    </span>
                                </div>
                            </div>
                        </a>
                    <% } %>
                <% }); %>
            <% } else { %>
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                </div>
            <% } %>
        </div>
    </div>
</div>
<script>
document.querySelectorAll('.module-toggle').forEach(checkbox => {
    checkbox.addEventListener('change', async (e) => {
        const isEnabled = e.target.checked;
        const guildId = e.target.dataset.guildId;
        const moduleName = e.target.dataset.modulePath;
        const statusText = e.target.parentElement.nextElementSibling;

        statusText.innerText = isEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
        statusText.style.color = isEnabled ? 'var(--success)' : 'var(--text-muted)';

        try {
            const response = await fetch(`/api/modules/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guildId, module: moduleName })
            });

            if (!response.ok) throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        } catch (err) {
            alert('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            e.target.checked = !isEnabled;
            statusText.innerText = !isEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
        }
    });
});
</script>